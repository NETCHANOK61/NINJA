<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>LPR-NINJA</title>
  <link rel="icon" href="./assets/external-ninja-cow-emoji-soft-fill-soft-fill-juicy-fish.png" alt="ninja-head"
    type="image/x-icon">

  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <!-- <link rel="stylesheet" href="./css/dataTable.css"> -->

  <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
  <script src="./js/sweetAlert.js"></script>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> -->
  <script src="./js/moment.js"></script>

</head>

<body>
  <!-- Image and text -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="car.html">
      <img src="./assets/external-ninja-cow-emoji-soft-fill-soft-fill-juicy-fish.png" width="40" height="40"
        class="d-inline-block align-top" alt="">
    </a>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">ตั้งค่า</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="suspect.html">Suspect <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="object.html">Object</a>
        </li>
      </ul>
    </div>
  </nav>
  <div style="padding: 2%;">
    <h3>Suspect Searching -ค้นหาคนและเสื้อผ้า</h3>
    <hr>
    <form id="myForm">
      <div class="row">
        <div class="col-5">
          <div class="form-group">
            <label for="Startdatetime">วันเริ่มต้น:</label>
            <input type="datetime-local" id="sdatetime" name="sdatetime" class="form-control">
          </div>
        </div>
        <div class="col-5">
          <div class="form-group">
            <label for="Enddatetime">วันสิ้นสุด:</label>
            <input type="datetime-local" id="edatetime" name="edatetime" class="form-control">
          </div>
        </div>
        <div class="col-5">
          <div class="form-group">
            <label for="CameraSelect">กล้อง:</label>
            <select class="form-control" id="camera_id">
              <option value="0">ทั้งหมด</option>
              <option value="กล้องทดสอบ-ขาเข้า-1">กล้องทดสอบ-ขาเข้า-1</option>
              <option value="กล้องทดสอบ-ขาเข้า-2">กล้องทดสอบ-ขาเข้า-2</option>
            </select>
          </div>
        </div>
        <div class="col-2" style="align-content: center;">
          <button type="submit" class="btn btn-info">ค้นหา</button>
          <button type="button" class="btn btn-warning" onclick="clearAll()">เคลียร์</button>
        </div>
      </div>
    </form>
    <hr>
    <button id="bulk-delete-1" class="btn btn-danger mb-3">ลบข้อมูลที่เลือก</button>
    <table id="example" class="display table-bordered text-center" style="width:100%">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all" /></th>
          <th>ข้อมูล</th>
          <th>รูป</th>
          <th style="background-color: #FFEEFC;">ข้อมูลวัตถุ</th>
          <th style="background-color: #FFEEFC;">การกระทำ</th>
          <!--  <th style="background-color: #FFEEFC;">ประเภท</th>
          <th>รูป</th>
          <th>ป้ายทะเบียน(%)</th>
          <th style="background-color: #FFEEFC;">ป้ายทะเบียน</th>
          <th style="background-color: #FFEEFC;">จังหวัด</th>
          <th>รูป</th>
          <th>ยี่ห้อ(%)</th>
          <th style="background-color: #FFEEFC;">ยี่ห้อ</th>
          <th>กระทำ</th> -->
        </tr>
      </thead>
      <tbody>
        <!-- Table body will be populated dynamically -->
      </tbody>
    </table>
    <button id="bulk-delete-2" class="btn btn-danger mb-3">ลบข้อมูลที่เลือก</button>
  </div>

  <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
  <script src="./js/jquery-3.6.0.js"></script>

  <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script> -->
  <script src="./js/poper.min.js"></script>

  <!-- <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script> -->
  <script src="./js/dataTables.min.js"></script>

  <script>

    // var baseUrl = 'http://49.0.82.233'; 
    var baseUrl = 'http://192.168.8.123';
    baseUrl = localStorage.getItem("storedURL") ? localStorage.getItem("storedURL") : baseUrl;
    var url_get = baseUrl + ':8003/gender_aware_result/list';
    var url_update = baseUrl + ':8003/gender_aware_result/';
    var url_cameras_all = baseUrl + ':8002/cameras/all'

    // Check local storage for previously selected dates
    var startDate = localStorage.getItem('startDate');
    var endDate = localStorage.getItem('endDate');
    baseUrl = localStorage.getItem("storedURL") ? localStorage.getItem("storedURL") : baseUrl;

    var dumpData = [];
    var now = new Date();

    $(document).ready(function () {

      // console.log(baseUrl);

      // If dates are not found in local storage, set default values (now and now - 1 hour)
      if (!startDate || !endDate) {

        // Adjust time by subtracting 1 hour in Thai time zone
        var th_now = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
        var th_time_prev = new Date(th_now);
        th_time_prev.setHours(th_time_prev.getHours() - 1);

        // Format the date part
        var year = th_now.getFullYear();
        var month = String(th_now.getMonth() + 1).padStart(2, '0');
        var day = String(th_now.getDate()).padStart(2, '0');

        // Format time to display in Thai locale
        var formattedTime = th_now.toLocaleTimeString('en-US', { hour12: false });
        var formattedTime_prev = th_time_prev.toLocaleTimeString('en-US', { hour12: false });

        // Concatenate date and time for startDate
        endDate = `${year}-${month}-${day}T${formattedTime}`;

        // Concatenate date and time for endDate
        startDate = `${year}-${month}-${day}T${formattedTime_prev}`;
      }

      // Set the default values in the date inputs
      $('#sdatetime').val(startDate.slice(0, 16)); // Truncate milliseconds
      $('#edatetime').val(endDate.slice(0, 16)); // Truncate milliseconds

      fetchData(startDate, endDate)

      $('#myForm').submit(function (event) {
        event.preventDefault(); // Prevent the form from submitting normally

        startDate = $('#sdatetime').val();
        endDate = $('#edatetime').val();
        localStorage.setItem('startDate', startDate);
        localStorage.setItem('endDate', endDate);

        $('#sdatetime').val(startDate.slice(0, 16)); // Truncate milliseconds
        $('#edatetime').val(endDate.slice(0, 16)); // Truncate milliseconds

        fetchData(startDate, endDate,)
      });
    });

    function fetchData(s, e) {
      $('#example tbody').empty();
      var camera_id = document.getElementById('camera_id').value;
      // Format the start time and end time strings
      const s_d = moment().subtract(1, 'hours').format('YYYY-MM-DD HH:mm:ss');
      const e_d = moment().format('YYYY-MM-DD HH:mm:ss');

      $.ajax({
        url: url_get,
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          "cam_id": camera_id == 0 ? null : camera_id,
        }),
        success: function (dumpData) {
          const classNames = ["กระเป๋า", "เข็มขัด", "บู๊ต", "รองเท้า", "เสื้อคลุม", "ชุดเดรส", "แว่นตากันแดด", "กางเกง", "เสื้อ", "กางเกงขาสั้น", "กระโปรง", "หมวก", "เครื่องประดับคอ"];
          const color = [{ text: 'ขาว', value: '#E8E8E8' },
          { text: 'แดง', value: '#ff0000' },
          { text: 'น้ำเงิน', value: '#0000ff' },
          { text: 'เหลือง', value: '#ffff00' },
          { text: 'ดำ', value: '#000000' },
          { text: 'ส้ม', value: '#ffa500' },
          { text: 'เขียว', value: '#008000' },
          { text: 'ม่วง', value: '#800080' },
          { text: 'เทา', value: '#808080' },
          { text: 'ชมพู', value: '#ffc0cb' },
          { text: 'น้ำตาล', value: '#a52a2a' },]

          dumpData.data.forEach(function (item) {
            var formattedDate = moment(item.create_at).format('YYYY-MM-DD HH:mm:ss');
            var obj_class = '';

            item.clothing.forEach(function (clothing_item, index) {
              obj_class += '<div class="obj-container">';
              obj_class += '<span>' + clothing_item.type + '</span>' + ': ' + '<select class="clothing-type">';
              classNames.forEach(function (className) {
                obj_class += '<option value="' + className + '"' + (className === clothing_item.type ? ' selected' : '') + '>' + className + '</option>';
              });
              obj_class += '</select>';

              // Add color select dropdown
              if (clothing_item.color.length > 0) {
                var a = clothing_item.color.length > 0 ? clothing_item.color[0].value : ''
                obj_class += '<select class="color-select">';
                color.forEach(function (colorOption) {
                  obj_class += '<option value="' + colorOption.text + '"' + (colorOption.text === a ? ' selected' : '') + '>' + colorOption.text + '</option>';
                });
                obj_class += '</select>';
              }

              obj_class += '<button class="delete-btn btn btn-secondary btn-sm" data-index="' + index + '">x</button></div><br>';
            });

            $('#example tbody').append('<tr>' +
              '<td><input type="checkbox" class="delete-checkbox" value="' + item._id + '"></td>' +
              '<td>' + item._id + '<br>' + formattedDate + '<br><b>' + item.camera_id + '</b></td>' +
              '<td align="center"><img class="zoom-image" src="http://' + item.pic_url + '" alt="Image In" style="width: 300px; cursor: pointer;"></td>' +
              '<td style="background-color: #FFEEFC;">' + 'เครื่องแต่งกาย :<br><button class="add-new-btn btn btn-primary">Add New</button><br>' + obj_class + '</td>' +
              '<td style="background-color: #FFEEFC;"><button class="save-btn btn btn-primary">Save</button></td>' +
              '</tr>');
          });

          // Event handler for clothing type change
          $('tbody').on('change', 'select.clothing-type', function () {
            var rowIndex = $(this).closest('tr').index();
            var index = $(this).closest('.obj-container').index();
            var selectedOption = $(this).val();
            var item = dumpData[rowIndex];
            if (item && item.clothing && item.clothing[index]) {
              item.clothing[index].type = selectedOption;
            }
          });

          // Event handler for color change
          $('tbody').on('change', 'select.color-select', function () {
            console.log("Color changed");
            var $container = $(this).closest('.obj-container');
            var rowIndex = $container.closest('tr').index();
            var index = $container.index();
            var selectedColor = $(this).val();
            var item = dumpData[rowIndex];
            console.log("Before modification:", item);
            if (item && item.clothing && item.clothing[index] && item.clothing[index].color) {
              item.clothing[index].color[0].value = selectedColor;
            }
            console.log("After modification:", item);
            // Update the displayed color
            $container.find('.color-text').text(selectedColor);
          });

          $('tbody').on('click', '.save-btn', function () {
            var rowIndex = $(this).closest('tr').index(); // Get the index of the row
            var rowData = dumpData.data[rowIndex]; // Get the corresponding data object
            console.log(rowData);
            return
            $.ajax({
              url: url_update + rowData._id, // Replace with the actual URL of your API
              method: 'PUT', // Use the appropriate HTTP method (PUT, POST, etc.)
              contentType: 'application/json',
              data: JSON.stringify(rowData),
              success: function (response) {
                showToast("Data updated successfully", "success");
                // setTimeout(function () {
                //   window.location.reload();
                // }, 1000);
              },
              error: function (error) {
                showToast("ไม่พบข้อมูล หรืออินเทอร์เน็ตมีปัญหา", "error");
                // setTimeout(function () {
                //   window.location.reload();
                // }, 1000);
                // console.error('Error updating data:', error);
              }
            });
          });

        },
        error: function (error) {
          showToast("ไม่พบข้อมูล หรืออินเทอร์เน็ตมีปัญหา", "error");
        }
      });
    }

    function showToast(message, type) {
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: type,
        title: message,
        showConfirmButton: false,
        timer: 3000
      });
    }

    $('#select-all').click(function () {
      var checkedStatus = this.checked;
      $('.delete-checkbox').each(function () {
        $(this).prop('checked', checkedStatus);
      });
    });

    $('#bulk-delete-1').click(function () {
      var selectedIds = $('.delete-checkbox:checked').map(function () {
        return $(this).val();
      }).get();
      del(selectedIds);
    });

    $('#bulk-delete-2').click(function () {
      var selectedIds = $('.delete-checkbox:checked').map(function () {
        return $(this).val();
      }).get();
      del(selectedIds);
    });

    function del(select) {
      if (select.length > 0) {
        // Loop through each selected ID
        select.forEach(function (id) {
          // Confirm before deletion
          $.ajax({
            url: url_update + id, // Use each item's _id in the request
            method: 'DELETE',
            contentType: 'application/json',
            success: function (response) {
              showToast("Data deleted successfully", "success");
              // Consider keeping track of completed requests to only reload once all have finished
            },
            error: function (error) {
              showToast("Error deleting data", "error");
              // console.error('Error deleting data:', error);
            },
            complete: function () {
              // Check if all deletions have been processed before reloading
              if (--select.length === 0) { // Decrement count and check if all requests completed
                // setTimeout(function () {
                //   window.location.reload();
                // }, 1000);
              }
            }
          });
        });
      } else {
        showToast("No items selected", "error");
      }
    }

    function clearAll() {
      localStorage.clear();
      document.getElementById('sdatetime').value = ''; // Replace 'datetime_input_id' with the actual ID of your datetime input element
      document.getElementById('edatetime').value = ''; // Replace 'datetime_input_id' with the actual ID of your datetime input element
    }
  </script>

</body>

</html>